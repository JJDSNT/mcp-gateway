{
  local_certs

  pki {
    ca local {
      root {
        format pem_file
        cert /etc/caddy/certs/root.crt
        key  /etc/caddy/certs/root.key
      }
      intermediate {
        format pem_file
        cert /etc/caddy/certs/intermediate.crt
        key  /etc/caddy/certs/intermediate.key
      }
    }
  }
}

# --- TUNNEL / ngrok (aceita qualquer Host em HTTP interno) ---
:80 {
  @mcp path /mcp* /mcp/*
  handle @mcp {
    reverse_proxy mcp-router:8080 {
      transport http {
        versions 1.1
      }
      flush_interval -1
    }
  }

  respond "MCP Gateway Lab OK\n" 200
}

# --- DEV LOCAL (TLS s√≥ para localhost) ---
https://localhost {
  tls {
    issuer internal
  }

  @mcp path /mcp* /mcp/*
  handle @mcp {
    reverse_proxy mcp-router:8080 {
      transport http {
        versions 1.1
      }
      flush_interval -1
    }
  }

  respond "MCP Gateway Lab OK\n" 200
}

http://localhost {
  redir https://localhost{uri} permanent
}
