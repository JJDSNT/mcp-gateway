# Caddyfile
#
# Reverse proxy for the MCP Gateway Lab.
# - Routes everything under /mcp/* to the Go mcp-router
# - Streaming-friendly (SSE)
# - TLS always on (localhost)
# - RSA local CA (certs/)
# Optional: local TLS (works for localhost/LAN testing)
# For Cloudflare Tunnel you can also run plain HTTP internally.

{
  local_certs

  pki {
    ca local {
      root {
        format pem_file
        cert /etc/caddy/certs/root.crt
        key  /etc/caddy/certs/root.key
      }
      intermediate {
        format pem_file
        cert /etc/caddy/certs/intermediate.crt
        key  /etc/caddy/certs/intermediate.key
      }
    }
  }
}

https://localhost {
  tls {
    issuer internal
  }

  @mcp path /mcp* /mcp/*

  handle @mcp {
    reverse_proxy mcp-router:8080 {
      transport http {
        versions 1.1
      }
      flush_interval -1
    }
  }

  respond "MCP Gateway Lab OK\n" 200
}

http://localhost {
  redir https://localhost{uri} permanent
}
